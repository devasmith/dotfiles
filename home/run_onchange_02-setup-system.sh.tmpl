#!/bin/bash
set -e

mkdir -p ~/Pictures/Screenshots

# --- Nerd Font (Waybar icons etc) ---
if ! fc-list | grep -qi "JetBrainsMono Nerd Font"; then
  echo "Installing JetBrainsMono Nerd Font..."

  FONT_DIR="$HOME/.local/share/fonts/JetBrainsMonoNerd"
  ZIP_URL="https://github.com/ryanoasis/nerd-fonts/releases/latest/download/JetBrainsMono.zip"

  mkdir -p "$FONT_DIR"

  tmpzip="$(mktemp -t JetBrainsMonoNerd.XXXXXX.zip)"
  curl -fsSL --retry 3 --retry-delay 1 -o "$tmpzip" "$ZIP_URL"

  unzip -o "$tmpzip" -d "$FONT_DIR" >/dev/null
  rm -f "$tmpzip"

  fc-cache -f >/dev/null

  echo "JetBrainsMono Nerd Font installed."
else
  echo "JetBrainsMono Nerd Font already present."
fi

if [ "$(hostnamectl --static)" != "nibble" ]; then
  sudo hostnamectl set-hostname nibble
fi

for group in video input libvirt; do
  if getent group "$group" >/dev/null; then
    sudo usermod -aG "$group" "{{ .chezmoi.username }}"
  fi
done

if [ ! -f /etc/sysctl.d/99-custom-limits.conf ]; then
  cat <<EOF | sudo tee /etc/sysctl.d/99-custom-limits.conf
fs.inotify.max_user_watches=524288
fs.inotify.max_user_instances=512
vm.max_map_count=262144
vm.swappiness=10
EOF
  sudo sysctl --system
fi

# Setup snapper
if ! sudo test -f /etc/snapper/configs/root; then
  echo "Initializing snapper..."
  sudo snapper -c root create-config /
fi

# Setup logind conf
sudo mkdir -p /etc/systemd/logind.conf.d
cat <<EOF | sudo tee /etc/systemd/logind.conf.d/custom.conf
[Login]
HandleLidSwitch=suspend
HandleLidSwitchExternalPower=ignore
HandleLidSwitchDocked=ignore
EOF

cat <<EOF | sudo tee /etc/systemd/system/battery-threshold.service
[Unit]
Description=Set ThinkPad battery charge threshold

[Service]
Type=oneshot
ExecStart=/usr/bin/bash -c 'echo 40 > /sys/class/power_supply/BAT0/charge_control_start_threshold'
ExecStart=/usr/bin/bash -c 'echo 80 > /sys/class/power_supply/BAT0/charge_control_end_threshold'

[Install]
WantedBy=multi-user.target
EOF

# Enable services
sudo systemctl enable --now earlyoom
sudo systemctl enable --now battery-threshold.service
systemctl --user enable --now clamp-bt-volume.timer
systemctl --user enable --now kanshi.service

# Disable >100% volume in gnome settings
gsettings set org.gnome.desktop.sound allow-volume-above-100-percent false

# Only setup AI stack if Ollama is installed
if ! command -v ollama &>/dev/null; then
  curl -fsSL https://ollama.com/install.sh | sh
  # Enable Ollama service
  sudo systemctl enable --now ollama || true

  # Enable Podman for containers
  systemctl --user enable --now podman

  # Setup Ollama models
  if systemctl is-active --quiet ollama 2>/dev/null; then
    # Wait for Ollama to be ready
    timeout 30 bash -c 'until curl -s http://localhost:11434/api/tags >/dev/null 2>&1; do sleep 1; done' 2>/dev/null || true

    for model in \
      qwen2.5-coder:7b-instruct-q4_K_M \
      qwen2.5-coder:3b-instruct-q4_K_M; do
      if ! ollama list 2>/dev/null | grep -q "$model"; then
        ollama pull "$model" || true
      fi
    done
  fi

  # Create Open WebUI container
  if ! podman container exists open-webui 2>/dev/null; then
    podman run -d \
      --name open-webui \
      --network host \
      -p 127.0.0.1:3000:8080 \
      -e OLLAMA_BASE_URL=http://127.0.0.1:11434 \
      -v open-webui:/app/backend/data \
      --restart always \
      ghcr.io/open-webui/open-webui:main

    mkdir -p ~/.config/systemd/user/
    podman generate systemd --name open-webui --new \
      --container-prefix="" --separator="" >~/.config/systemd/user/open-webui.service
    systemctl --user daemon-reload
    systemctl --user enable open-webui.service
  else
    podman start open-webui 2>/dev/null || true
  fi
fi
